## 网络协议

互联网是如何工作的？

### 一、 计算机网络模型

国际标准模型是 OSI 七层参考模型，它是一个参考，不是一个具体实现，又叫网络互联模型，TCP/IP 协议是参考 OSI 模型进行实现的。OSI 模型分七层：应用层，表示层，会话层，传输层，网络层，数据链路层，物理层。TCP/IP 主要是分四层，应用层，传输控制层，网络层，链路层。将 OSI 模型的应用层，表示层，会话层组成一个应用层，OSI 的链路层和物理层分成链路层。
比 OSI 模型少了三层，结构简单很多。

#### 为什么会有模型？

模型主要就是标准，定义计算机网络的标准，因为早期的网络通信是点对点的通信，那么不同的生产厂商之间的产品和设备不能相互兼容，为了解决这个问题，所以国际上提供了一个标准 OSI 模型标准，所有的厂商都去遵循，兼容这个标准生产。

#### 相同点

- 都是通过层的结构组成的。
- 都是网络通信标准。

#### 区别

- 分层结构不同，OSI 是七层，TCP/IP 是四层
- OSI 模型是先有模型，再有协议，它是一种设计理论，根据这个去设计接口等规范。TCP/IP 是先有了 http,tcp 等具体的协议，再把这些协议划分到不同的模型层上面去，它是以实际应用为主.
- OSI 更适合对硬件的开发，比如电流，电压等接口的标准以及对程序的设计。TCP/IP 更多是计算机建立链接需求，主流使用是协议站，比如我和你之间的通信。

### 二、 TCP/IP 协议（四层模型）

TCP/IP 是网络通信的一个标准，所有的互联网通信都必须遵循这个标准，它是一个由多个协议组成的协议族，他在一定程度上参考了 OSI 模型结构，在 OSI 模型的结构上简化为四层结构。
应用层，传输层，网络层，链路层。不同的层，有不同的协议。其中应用层是指程序员关注的地方，其他的传输层，网络层，链路层都是属于内核。

#### 为什么要网络分层

- 为了简化网络的复杂度
- 有更好的可拓展性，复杂的网络通信通过分层来管理，层与层之间不会相互影响，如果后期需要替换某个应用，🈯️ 需要知道层与层之间的接口连接进行。

#### 应用层

应用层是 tcp/ip 协议的第一层，是直接为应用进程提供服务的，符合应用层的一些协议，主要准备某种协议的数据，发送前通过内核完成和别人的链接。
应用层协议有 HTTP,TFTP,FTP,NFS,WAIS,SMTP,Telent,DNS,SNMP。

1. 对不同的应用程序，他们会根据自己的需求来使用应用层不同的协议。比如：

- 邮件传输使用了 SMTP 协议
- 互联网传输使用了 HTTP 协议
- 远程登录服务使用了 TELNET 协议

2. 应用层还能加密，解密，格式化数据。
3. 应用可以建立或解除与其他节点的联系，可以充分节省网络资源。

#### 传输控制层

传输控制层是端对端的通信，是指应用程序使用什么协议进行通过，给应用层提供端口号。不同协议对应不同的端口号，传输层有两个协议，TCP 协议和 UDP 协议。

- TCP 协议：面向连接的，可靠的传输协议
- UDP 协议:无连接，高效的，不可靠的数据报文协议

总体来说，TCP 协议传输效率低，但可靠性强；UDP 协议传输效率高，但可靠性略低，适用于传输可靠性要求不高、体量小的数据（比如 QQ 聊天数据）。

##### 应用层和传输层的联系

应用层是使用传输层的端口号进行传输的，比如 http 使用 80 端口，这个 80 端口是传输层提供的端口，http 是要通过 tcp 去建立链接的。

#### 网络层

网络层主要是负责将报文从一台主机传到另一台主机，主要是包括寻址（IP）和路由（router）。
网络层包括的协议有：ipv4,ipv6,ICMP,IGMP。

##### mac 地址

也叫做物理地址，硬件地址，是由设备出厂商设置的，计算机出厂时就写死在网卡里面了，每个网卡的 mac 地址全世界独一无二，固定不能改变的

##### IP 地址

是指网络地址，软件地址，每台计算机使用的 ip 地址是由 ISP（指提供 Internet 服务的公司，比如电信、网通、移动等）负责分配的，通常情况下，计算机每次链接不同的网络使用的 ip 地址不一样。IP 地址是动态的，可改变的。

##### mac 地址和 IP 地址的区别

- 地址长度不同，mac 的长度是为 48 位，ip 的地址长度为 32 位。
- 协议层不同，mac 运用在第二层数据链路层，ip 运用在第三层网络层。
- 分配依据不同，mac 分配是基于制造商，ip 分配基于网络拓朴

##### 路由器

一台独立的拥有 mac 地址的设备，把数据包进行一次转发。
注意，路由器的每一个端口都有独立的 mac 地址
路由只要是负责 ip 地址的寻找

##### 子网

就是给若干个 ip 地址按照某种规则分组，将处在一个大网的若干个 ip 划分成不同组的小网。同处在一个小网里面的 ip 就是被称为同一个子网。

##### 子网掩码

给某台计算机设置一个子网掩码，将 ip 地址和子网掩码进行与运算，得到子网。

##### 默认网关

每台计算机配置一个 ip 地址，用来将数据包发给这个 ip 地址(实际就是路由的 ip 地址)

##### 路由表

确定目的 ip 和路由接口的对应关系，也就是说，我的数据应该从路由的哪个接口出去，路由表是通过子网分组对应接口，同一个子网的不同 ip 对应的是同一个路由接口。

##### arp 协议

通过 ip 地址找到对应的 mac 地址，电脑里面会缓存一张 arp 表，arp 表缓存了 ip 和 mac 的对应关系，通过 arp 表找到对应的 mac 地址。

##### 网络层工作过程

- 首先网络层协议封装数据包信息有：信封(ip 报文头)，收件人（源 IP 地址），发件人（目的 ip 地址）
- 路由器收到报文数据包，会去解析这个报文，解封装，会查看到目的 ip 地址
- 路由通过查找路由表确定目的 ip 和路由的接口的对应关系，
- 如果路由表有下一跳（记录链接的另外一个路由的 ip）的记录,通过下一跳找到另外一个路由接口对应的目的 ip
- 链路层需要知道目的 ip 对应的 mac 地址，于是查看其 arp 缓存，找到目的 ip 对应的 mac 地址，然后将数据封装在路由链路层头部，并且从路由对应的接口发出去

#### 链路层

链路层又称数据链路层或者网络接口层，用来处理连接网络的硬件部分，该层包括操作系统硬件的设备驱动，NIC（网卡），光纤等物理可见部分，还包括连接器等一切传输媒介。

### 三、 TCP 协议

面向连接的，可靠的传输协议。
:::tip 什么是连接
三次握手
:::

#### 什么是三次握手?

客户端和服务端建立连接了 ，各自开辟了一个队列空间（queue 空间 socket）,双方有资源为对方服务。

- 客户端发送 SYN 给服务端，请求服务端建立建立
- 服务端收到 SYN 回应一个 SYN+ACK 给客户端，告诉客户端我收到它的连接请求了，并且愿意和他建立连接
- 客户端收到服务端的 SYN+ACK 回应再次发送 ACK 告诉服务端，我收到你的请求同意了，接下来我们可以进行对话了。

#### 为什么是三次握手？

如果是两次握手，那么 TCP 建立连接只是客户端单方面的，会造成资源的浪费。

#### TCP 四次挥手

- 客户端发一个 FIN 报文数据包给服务器请求断开连接
- 服务器收到 FIN 报文回应一个 ACK 数据包告诉客户端我收到你的断开请求了，正在分配资源，然后进入到 close wait 状态
- 等到服务 close 状态之后， 有资源断开服务器的连接的了，再发送一个 FIN+ACK 断开连接的报文，服务器进入到 last ack 状态
- 客户端收到服务器断开连接到 FIN+ACK 报文请求，再次发送 ACK 告诉服务器，我收到你的断开报文了，然后断开。

#### TCP 的四次挥手为什么是四次，第二部和第三部能不能合并？

第二步和第三步不能合并，服务器收到客户端断开连接的请求后，服务器不可能立马有资源去处理客户端断开连接的请求，
然而客户端每次超过 30 秒没有收到服务端的回应就会重发请求。但是服务器处理断开请求是需要时间的，所以这个时候，服务器需要告诉客户端，他已经收到了客户端的断开请求，
正在等待资源的分配，进入到 close wait 状态。进行了第二部。等到有资源处理了，服务端再发一个断开连接到数据报文回应给客户端，他正在处理断开连接。

#### 什么是 TCP 长连接？

就是一直连接

### 三、http 协议

### 参考地址:

[tcp/ip 工作原理和图解](https://zhuanlan.zhihu.com/p/563613309?utm_source=zhihu&utm_id=0)

[aaa](https://zhuanlan.ss.com/p/563613309?utm_source=zhihu&utm_id=0)
